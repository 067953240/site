{% extends "base.html" %}
{% load static from staticfiles %}
{% block css %}
    <script src="{% static 'simple-comet.js' %}" type="text/javascript"></script>
    <script src="{% static 'common.js' %}" type="text/javascript"></script>
    {% if not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                function on_receive(message) {
                    var packet = message.split(" ");
                    var list = $("#test-cases");
                    switch (packet[0]) {
                        case "test-case":
                            list.append("<b>Test case #{0}:</b> {1} [{2}s, {3}kb] ({4}/{5})<br/>".format(packet[1], packet[2], packet[3], packet[4], packet[5], packet[6]));
                            break;
                        case "grading-begin":
                            $("#execution-title").append("<h3>Execution Results</h3>");
                            break;
                        case "grading-end":
                            list.append("<br/><br/><b>Final score:</b> {0}/{1}<br/>".format(packet[3], packet[4]));
			    $("#abort-button").remove();
                            break;
                        case "compile-error":
                            $("#execution-title").append("<h3>Compilation Error</h3>");
                            list.append(packet[1].replace("\f", " ").replace("\n", "<br/>"));
			    $("#abort-button").remove();
                            break;
                        default:
                            return;
                    }
                }

                SimpleComet.subscribe("{{ SIMPLE_COMET_URL }}sub_{{ submission.id }}.jsonp", function (resp) {
                    var messages = resp['messages']['sub_{{ submission.id }}'];
                    for (var i = 0; i < messages.length; ++i) {
                        on_receive(messages[i].content);
                    }
                });
                SimpleComet.start();
            });
        </script>
    {% endif %}
{% endblock %}
{% block body %}
    Submitted on {{ submission.date }}
    <br/>
    {% if request.user == submission.user.user %}
        <a href="{% url 'judge.views.problem_submit' submission.problem.code submission.id %}">Click here to revise and
            resubmit!</a>
        <br/>
    {% endif %}
    <br/>
    {% if not submission.is_graded and (request.user == submission.user.user or submission.user.is_admin) %}
        <div id="abort-button">
            <form action="{% url 'judge.views.abort_submission' submission.id %}" method="post">
                {% csrf_token %}
                <input type="submit" value="Abort"/>
            </form>
        </div>
    {% endif %}
    <br/>
    <div id="execution-title">
        {% if submission.is_graded %}

        {% endif %}
    </div>
    <br/>

    <div id="test-cases">
        {% if submission.is_graded %}
            {% for case in test_cases %}
                <b>Test case #{{ forloop.counter }}:</b> {{ case.status }} [{{ case.time|floatformat:"3" }}s,
                {{ case.memory }}kb] ({{ case.points }}/{{ case.total }})<br/>
            {% endfor %}
            <br/><br/>
            {% if submission.result != "AB" %}
                <b>Final score:</b> {{ submission.points }}/{{ submission.problem.points }}
            {% else %}
                <b>Submission aborted!</b>
            {% endif %}
        {% endif %}
        <br/>
    </div>
{% endblock %}
