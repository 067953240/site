{% extends "base.html" %}
{% load static from staticfiles %}
{% load mathtag %}

{% block css %}
    <link rel="stylesheet" href="{% static "status.css" %}">
    <script src="{% static 'simple-comet.js' %}" type="text/javascript"></script>
    <script src="{% static 'common.js' %}" type="text/javascript"></script>
    {% if not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                function top_table_id() {
                    var table = document.getElementById("submissions-table");
                    var top = parseInt(table.getElementsByTagName("tr").getAttribute("id").split("-")[1]);
                    return top;
                }

                function on_receive(message) {
                    var packet = message.split(" ");
                    var table = document.getElementById("submissions-table");
                    switch (packet[0]) {
                        case "submission-start":
                            var id = parseInt(packet[1]);
                            if (id > top_table_id()) {
                                var html = "";
                                var status = packet[2];
                                var language = packet[3];
                                var user = packet[3];
                                var dstatus = '<img src="{% static 'loading.gif' %}" alt="Grading...">';
                                html = ('<tr id={0}>' +
                                        '<td style="width:10%" class="{1}">' +
                                        dstatus +
                                        '<br/>' +
                                        '<span style="font-size:0.7em;font-weight:bold">{1} | {2}</span>' +
                                        '</td>' +

                                        '<td style="width:90%;text-align:left;padding-left:20px">' +
                                        'I don\'t have enough patience with JavaScript to do this.' +
                                        '</td>' +

                                        '<td style="white-space:nowrap">' +
                                        '<b>---</b><br/>---' +
                                        '</td>' +
                                        '</tr>').format(id, status, language);
                                table.innerHTML = html + table.innerHTML;
                            }
                            break;
                        default:
                            return;
                    }
                }

                SimpleComet.subscribe("{{ SIMPLE_COMET_URL }}submissions.jsonp", function (resp) {
                    var messages = resp['messages']['submissions'];
                    for (var i = 0; i < messages.length; ++i) {
                        on_receive(messages[i].content);
                    }
                });
                SimpleComet.start();
            })
            ;
        </script>
    {% endif %}
{% endblock %}

{% block body %}
    {% include "results_table.html" %}
    {% include "submissions_pages.html" %}
    <div class="table" style="width:75%;border:0px;">
        <table id="submissions-table">
            {% for submission in submissions %}
                <tr id="submission-{{ submission.id }}">
                    <td style="width:10%" class="
                    {% if submission.status == 'IE' or submission.status == 'CE' %}{{ submission.status }}
                    {% else %}{{ submission.result }}{% endif %}">
                        {% if not submission.is_graded %}
                            <img src="{% static 'loading.gif' %}" alt="Grading...">
                        {% else %}
                            <span style="font-size:1.3em;color:black">{{ submission.points|default_if_none:0|floatformat:"-2" }} / {{ submission.problem.points|floatformat:"0" }}</span>
                        {% endif %}
                        <br/>
                        <span style="font-size:0.7em;font-weight:bold">{{ submission.result|default_if_none:submission.status }} | {{ submission.language.key }}</span>
                    </td>
                    <td style="width:90%;text-align:left;padding-left:20px">
                        {% if show_problem %}
                            <span style="font-size:1.3em;font-weight:bold">
                                <a href="{% url 'judge.views.problem' submission.problem.code %}">{{ submission.problem.name }}</a>
                            </span>
                            <br/>
                        {% endif %}
                        <span class="{% if submission.user.is_admin %}admin{% else %}user{% endif %}">
                            <a href="{% url 'judge.views.user' submission.user.user.username %}">{{ submission.user.user.username }}</a>
                        </span>
                        <span style="color:#555">on {{ submission.date }}</span>
                    </td>
                    {% if can_see_results %}
                        <td style="white-space:nowrap">
                            <a href="{% url 'judge.views.submission_status' submission.id %}">View</a>
                        </td>
                    {% endif %}
                    <td style="white-space:nowrap">
                        {% if submission.status != "QU" and submission.status != "CE" and submission.status != "IE" %}
                            <b>
                                {% if "TLE" != submission.result %}
                                    {{ submission.time|default_if_none:0|floatformat:"2" }}s
                                {% else %}
                                    ---
                                {% endif %}
                            </b>
                            <br/>
                            {% with memory=submission.memory|default_if_none:0 %}
                                {% if memory < 1000 %}
                                    {{ memory|floatformat:"-2" }} KB
                                {% else %}
                                    {% math memory "$1 / 1024" as megabytes %}
                                    {{ megabytes|floatformat:"-2" }} MB
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <b>---</b>
                            <br/>
                            ---
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    {% include "submissions_pages.html" %}
{% endblock %}
