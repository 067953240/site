{% extends "base.html" %}
{% load static from staticfiles %}
{% load mathtag %}

{% block css %}
    <link rel="stylesheet" href="{% static "status.css" %}">
    <script src="{% static 'simple-comet.js' %}" type="text/javascript"></script>
    <script src="{% static 'common.js' %}" type="text/javascript"></script>
    {% if not submission.is_graded %}
        <script type="text/javascript">
            $(function () {
                function top_table_id() {
                    return parseInt($('#submissions-table').find('tr:first-child').attr('id'));
                }

                function on_receive(message) {
                    var packet = message.split(" ");
                    var table = $('#submissions-table');
                    switch (packet[0]) {
                        case "submission-start":
                            var id = parseInt(packet[1]);
                            if (id > top_table_id()) {
                                var html = "";
                                var problem = packet[2].replace("\f", " ");
                                var status = packet[3];
                                var language = packet[4];
                                var user = packet[5];
                                var clazz = ["user", "admin"][parseInt(packet[6])];
                                var date = packet[7].replace("\f", " ");
                                var dstatus = '<img src="{% static 'loading.gif' %}" alt="Grading...">';
                                html = ('<tr id={0}>' +
                                        '<td style="width:10%" class="{1}">' +
                                        '<span class="score">' + dstatus + '</span>' +
                                        '<br/>' +
                                        '<span style="font-size:0.7em;font-weight:bold">' +
                                        '<span class="status">{1}</span> | <span class="language">{2}</span></span>' +
                                        '</td>' +

                                        '<td style="width:90%;text-align:left;padding-left:20px">' +
                                        '<span style="font-size:1.3em;font-weight:bold">' +
                                        '<a href="/problems/{3}">{3}</a>' +
                                        '</span>' +
                                        '<br/>' +
                                        '<span class="{4}">' +
                                        '<a href="/user/{5}">{5}</a>' +
                                        '</span>' +
                                        '<span style="color:#555"> sometime after the Big Bang</span>' +
                                        '</td>' +

                                        '<td style="white-space:nowrap">' +
                                        '<span class="time"><b>---</b></span><br/><span class="memory">---</span>' +
                                        '</td>' +
                                        '</tr>').format(id, status, language, problem, clazz, user);
                                table.prepend(html);
                            }
                            break;
                        case "submission-status":
                        {
                            var info = table.find("tr#" + packet[1]).find('td:first-child');
                            info.find('span.status').html(packet[2]);
                            info.removeClass().addClass(packet[2]);
                        }
                            break;
                        case "submission-end":
                        {
                            var row = table.find("tr#" + packet[1]);
                            var info = row.find('td:first-child');
                            info.find('span.status').html(packet[6]);
                            info.find('span.score').html('<span style="font-size:1.3em;color:black">{0} / {1}</span>'.format(packet[4], packet[5]).replace(/\.0+/g, ''));
                            info.removeClass().addClass(packet[6]);
                            row.find('span.time').html('<b>{0}s</b>'.format(packet[2]));
                            row.find('span.memory').html('{0}kb'.format(packet[3]));
                            break;
                        }
                        default:
                            return;
                    }
                }

                SimpleComet.subscribe("{{ SIMPLE_COMET_URL }}submissions.jsonp", function (resp) {
                    var messages = resp['messages']['submissions'];
                    for (var i = 0; i < messages.length; ++i) {
                        on_receive(messages[i].content);
                    }
                });
                SimpleComet.start();
            })
            ;
        </script>
    {% endif %}
{% endblock %}

{% block body %}
    {% include "results_table.html" %}
    {% include "submissions_pages.html" %}
    <div class="table" style="width:75%;border:0px;">
        <table id="submissions-table">
            {% for submission in submissions %}
                <tr id="{{ submission.id }}">
                    <td style="width:10%" class="
                    {% if submission.status == 'IE' or submission.status == 'CE' %}{{ submission.status }}
                    {% else %}{{ submission.result }}{% endif %}">
                        <span class="score">
                            {% if not submission.is_graded %}
                                <img src="{% static 'loading.gif' %}" alt="Grading...">
                            {% else %}
                                <span style="font-size:1.3em;color:black">{{ submission.points|default_if_none:0|floatformat:"-2" }} / {{ submission.problem.points|floatformat:"0" }}</span>
                            {% endif %}
                        </span>
                        <br/>
                        <span style="font-size:0.7em;font-weight:bold">
                            <span class="status">{{ submission.result|default_if_none:submission.status }}</span> |
                            <span class="language">{{ submission.language.key }}</span>
                        </span>
                    </td>
                    <td style="width:90%;text-align:left;padding-left:20px">
                        {% if show_problem %}
                            <span style="font-size:1.3em;font-weight:bold">
                                <a href="{% url 'judge.views.problem' submission.problem.code %}">{{ submission.problem.name }}</a>
                            </span>
                            <br/>
                        {% endif %}
                        <span class="{% if submission.user.is_admin %}admin{% else %}user{% endif %}">
                            <a href="{% url 'judge.views.user' submission.user.user.username %}">{{ submission.user.user.username }}</a>
                        </span>
                        <span style="color:#555">on {{ submission.date }}</span>
                    </td>
                    {% if can_see_results %}
                        <td style="white-space:nowrap">
                            <a href="{% url 'judge.views.submission_status' submission.id %}">View</a>
                        </td>
                    {% endif %}
                    <td style="white-space:nowrap">
                        {% if submission.status != "QU" and submission.status != "CE" and submission.status != "IE" %}
                            <span class="time">
                                <b>
                                    {% if "TLE" != submission.result %}
                                        {{ submission.time|default_if_none:0|floatformat:"2" }}s
                                    {% else %}
                                        ---
                                    {% endif %}
                                </b>
                            </span>
                            <br/>
                            <span class="memory">
                            {% with memory=submission.memory|default_if_none:0 %}
                                {% if memory < 1000 %}
                                    {{ memory|floatformat:"-2" }} KB
                                {% else %}
                                    {% math memory "$1 / 1024" as megabytes %}
                                    {{ megabytes|floatformat:"-2" }} MB
                                {% endif %}
                            {% endwith %}
                            </span>
                        {% else %}
                            <span class="time"><b>---</b></span><br/>
                            <span class="memory">---</span>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    </div>
    {% include "submissions_pages.html" %}
{% endblock %}
