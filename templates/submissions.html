{% extends "base.html" %}
{% load static from staticfiles %}
{% load mathtag %}
{% load admin_urls %}

{% block css %}
    <link rel="stylesheet" href="{% static "status.css" %}">
    <script src="{% static 'common.js' %}" type="text/javascript"></script>
    {% if dynamic_update %}
        <script type="text/javascript">
            $(function () {
                var socket = new WebSocket("{{ EVENT_DAEMON_LOCATION }}");
                var table = $('#submissions-table');

                socket.onopen = function (event) {
                    socket.send(JSON.stringify({
                        command: 'start-msg',
                        start: {{ last_msg }}
                    }));
                    socket.send(JSON.stringify({
                        command: 'set-filter',
                        filter: ['submissions']
                    }));
                };

                socket.onmessage = function (event) {
                    var data = JSON.parse(event.data);
                    if (data.message.type == 'update-submission') {
                        var id = data.message.id;
                        var cell = table.find('tr#' + id);
                        if (cell.length < 1) {
                            table.prepend('<tr id="{0}"></tr>'.format(id));
                            cell = table.find('tr#' + id);
                        }
                        $.ajax({
                            url: '{% url 'judge.views.single_submission_query' %}',
                            data: {id: id},
                            success: function (data, textStatus, jqXHR) {
                                cell.html(data.responseText);
                            },
                            error: function (data, textStatus, jqXHR) {
                                console.log('Failed to update submission: ' + id);
                            }
                        });
                    }
                };
            });
        </script>
    {% endif %}
{% endblock %}

{% block body %}
    <div class="info-float" style="width:20%">
        {% include "results_table.html" %}
    </div>
    <div style="margin-bottom:10px;">
    	{% include "submissions_pages.html" %}
    </div>
    <div class="table" style="width:75%;border:0px;">
        <table id="submissions-table">
            {% for submission in submissions %}
                <tr id="{{ submission.id }}">
                    {% include "submission_row.html" %}
                </tr>
            {% endfor %}
        </table>
    </div>
    <div style="margin-top:10px;">
    	{% include "submissions_pages.html" %}
    </div>
{% endblock %}
